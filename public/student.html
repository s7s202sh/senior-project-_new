<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-8">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-green-800">Student Dashboard</h1>
      <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-xl hover:bg-red-600">Logout</button>
    </div>

    <!-- Student Info Section -->
    <div class="mb-6">
      <h2 class="text-xl font-semibold">Your Info</h2>
      <button id="editInfoBtn" class="bg-yellow-500 text-white px-4 py-2 rounded-xl hover:bg-yellow-600">Edit Info</button>
      <div id="studentInfoDisplay" class="mt-4">
        <p class="text-lg font-medium">Hello, <span id="displayStudentName"></span> (ID: <span id="displayStudentId"></span>)</p>
      </div>
      <div id="studentInfoForm" class="mt-4 hidden">
        <input id="studentName" type="text" placeholder="Your Name" class="w-full p-2 border rounded-xl" required />
        <input id="idInput" type="text" pattern="\d+" placeholder="Your Student ID (Numbers Only)" class="w-full p-2 border rounded-xl mt-2" required />
        <button id="saveInfoBtn" class="bg-blue-600 text-white px-4 py-2 mt-2 rounded-xl hover:bg-blue-700">Save Info</button>
      </div>
    </div>

    <hr class="my-6" />

    <!-- My Project Section -->
    <h2 class="text-3xl font-bold text-green-800 mb-4">My Project</h2>
    <div id="myProject" class="space-y-4 mb-8">
      <!-- Chosen project appears here -->
    </div>

    <!-- Available Projects Section -->
    <h2 class="text-3xl font-bold text-green-800 mb-6">Available Projects</h2>
    <div id="projects" class="space-y-4">
      <!-- Projects will be loaded here -->
    </div>
  </div>

  <!-- Firebase SDK + Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCOhTTs-DuxLZ2kjydpsndmXSKGiQAfn68",
      authDomain: "project-manager-new.firebaseapp.com",
      projectId: "project-manager-new",
      storageBucket: "project-manager-new.appspot.com",
      messagingSenderId: "1045917197054",
      appId: "1:1045917197054:web:59bfcc5bb22bbc279dfbaf"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const projectsContainer = document.getElementById('projects');
    const myProjectContainer = document.getElementById('myProject');
    const studentInfoDisplay = document.getElementById('studentInfoDisplay');
    const studentInfoForm = document.getElementById('studentInfoForm');
    const studentNameInput = document.getElementById('studentName');
    const idInput = document.getElementById('idInput');
    const saveInfoBtn = document.getElementById('saveInfoBtn');
    const editInfoBtn = document.getElementById('editInfoBtn');
    const displayStudentName = document.getElementById('displayStudentName');
    const displayStudentId = document.getElementById('displayStudentId');
    const logoutBtn = document.getElementById('logoutBtn');

    let currentUser = null;
    let studentName = "";
    let studentId = "";

    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        loadStudentInfo();
        loadMyProject();
      } else {
        alert("You must be logged in.");
        window.location.href = "login.html";
      }
    });

    logoutBtn.addEventListener('click', async () => {
      await signOut(auth);
      alert("Logged out.");
      window.location.href = "index.html";
    });

    async function loadStudentInfo() {
      const ref = doc(db, "students", currentUser.uid);
      const docSnap = await getDoc(ref);
      if (docSnap.exists()) {
        studentName = docSnap.data().name;
        studentId = docSnap.data().studentId;
        displayStudentName.textContent = studentName;
        displayStudentId.textContent = studentId;
        studentInfoForm.style.display = 'none';
        studentInfoDisplay.style.display = 'block';
      } else {
        studentInfoForm.style.display = 'block';
        studentInfoDisplay.style.display = 'none';
      }
    }

    editInfoBtn.addEventListener('click', () => {
      studentInfoDisplay.style.display = 'none';
      studentInfoForm.style.display = 'block';
    });

    saveInfoBtn.addEventListener('click', async () => {
      studentName = studentNameInput.value.trim();
      studentId = idInput.value.trim();
      if (!studentName || !studentId) return;

      await setDoc(doc(db, "students", currentUser.uid), {
        name: studentName,
        studentId: studentId
      });
      alert("Info saved!");
      loadStudentInfo();
    });

    async function loadProjects() {
      const querySnapshot = await getDocs(collection(db, "projects"));
      projectsContainer.innerHTML = "";

      for (const docSnap of querySnapshot.docs) {
        const projectData = docSnap.data();
        const { name, description, supervisorId } = projectData;

        let supervisorName = "Unknown Supervisor";
        if (supervisorId) {
          const supDoc = await getDoc(doc(db, "supervisors", supervisorId));
          if (supDoc.exists()) supervisorName = supDoc.data().name;
        }

        const container = document.createElement("div");
        container.className = "border p-4 rounded-xl bg-gray-50 space-y-2";
        container.innerHTML = `
          <p class="text-sm text-gray-500">Supervisor: <span class="font-semibold">${supervisorName}</span></p>
          <h2 class="text-xl font-semibold text-green-900">${name}</h2>
          <p class="text-gray-700">${description}</p>
          <button class="chooseBtn bg-green-600 text-white px-3 py-1 rounded-xl">Choose</button>
          <div class="hidden teamForm mt-2">
            <input type="text" class="teamInput w-full p-1 border rounded" placeholder="Enter teammate student ID" />
            <button class="addMore text-blue-600 mt-1">+ Add more</button>
            <button class="submitTeam bg-blue-600 text-white px-3 py-1 mt-2 rounded-xl">Submit</button>
          </div>`;

        const chooseBtn = container.querySelector(".chooseBtn");
        const teamForm = container.querySelector(".teamForm");
        const submitBtn = container.querySelector(".submitTeam");
        const addMore = container.querySelector(".addMore");
        const teamInput = container.querySelector(".teamInput");

        chooseBtn.addEventListener("click", () => teamForm.classList.toggle("hidden"));

        addMore.addEventListener("click", () => {
          const newInput = document.createElement("input");
          newInput.type = "text";
          newInput.placeholder = "Enter teammate student ID";
          newInput.className = "teamInput w-full p-1 border rounded mt-1";
          teamForm.insertBefore(newInput, submitBtn);
        });

        submitBtn.addEventListener("click", async () => {
          const ids = [...container.querySelectorAll(".teamInput")].map(i => i.value.trim()).filter(Boolean);
          ids.push(studentId);
          const team = [...new Set(ids)].map(id => ({ id }));

          await setDoc(doc(db, "studentProjects", currentUser.uid), {
            projectName: name,
            members: team
          });

          alert(`Project '${name}' selected. Waiting for others to accept.`);
          loadMyProject();
        });

        projectsContainer.appendChild(container);
      }
    }

    async function loadMyProject() {
      myProjectContainer.innerHTML = "";
      const myProj = await getDoc(doc(db, "studentProjects", currentUser.uid));
      if (myProj.exists()) {
        const { projectName, members } = myProj.data();
        const html = `
          <div class="border p-4 rounded-xl bg-blue-50">
            <h2 class="text-xl font-semibold text-green-900">${projectName}</h2>
            <p class="text-sm text-gray-600">Your Team:</p>
            <ul class="list-disc pl-5">
              ${members.map(m => `<li>ID: ${m.id}</li>`).join('')}
            </ul>
          </div>
        `;
        myProjectContainer.innerHTML = html;
      }
    }

    loadProjects();
  </script>
</body>
</html>









